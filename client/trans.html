<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="trans.css">
    <title>East Europe Translater</title>
    <script>
        window.onload = function(){
            //글자수 제한
            const text = document.getElementById('text');
            text.addEventListener('keyup',function(e){
                var content = this.value;
                var counter = document.getElementById('text_cnt');

                counter.innerHTML = "("+content.length+" / 3000)";

                if(content.length > 3000) {
                    alert("3000자를 초과하였습니다.");
                    this.value = content.substring(0, 3000);
                    counter.innerHTML = "(3000 / 3000)";
                }
            });
            //번역할 내용 보내는 코드
            var KRcontentForm = document.getElementById('KRcontent');
            KRcontentForm.addEventListener('submit', function (event) {
                //submit 버튼 클릭 시 나올 내용
                event.preventDefault();

                const body = JSON.stringify(
                    Object.fromEntries(new FormData(event.target))
                )

                //Wrap1 post request
                fetch(KRcontentForm.action, {
                    method: 'POST',
                    headers: {
                    'Content-Type': 'application/json',
                    },
                    mode: 'cors',
                    body,
                }).then(function(response) {
                    //status Error
                    if (response.status >= 400 && response.status < 600) {
                        alert("Error(check your console)");
                        throw new Error("Bad response from server");
                    }
                    return response;
                }).then(function (res) {
                    res.text().then(function (data) {
                        //string to array
                        var start = data.indexOf("[");
                        var end = data.indexOf("]", start+1);

                        var str = data.substring(start+1, end); 
                        var tmpList = str.replace(/"/gi,' ').split(",");
                        const list = tmpList.map(x=>x.trim());
                        return list;
                    }).then(function(arr){
                        //make refresh
                        var parentNode = document.querySelector(".eng");
                        while (parentNode.firstChild) {
                            parentNode.removeChild(parentNode.firstChild);
                        };
                        //string to button
                        const tags = arr.map(x=>"<button>"+x+"</button>");
                        console.log(tags);
                        tags.forEach(function(tag){
                            document.querySelector(".eng").insertAdjacentHTML('beforeend',tag);
                        });
                        var EngButton = document.querySelectorAll('.eng button');
                        return EngButton;
                    }).then(function(EngButton){
                        //when eng button click
                        [].forEach.call(EngButton,function(btn){ 
                            btn.addEventListener("click",function(e){
                                //Find the Selected languege
                                var lang_length = document.getElementsByName('lang').length;
                                for (var i=0; i<lang_length; i++) {
                                    if (document.getElementsByName("lang")[i].checked == true) {
                                        var SelectedLang= document.getElementsByName("lang")[i].value;
                                    }
                                }

                                //make object for request
                                const body = JSON.stringify(
                                    {
                                        "text": this.innerText
                                    }
                                );
                                
                                //Select URL acorrding to languege
                                function GetURL (SelectedLang) {
                                    if(SelectedLang == "romania") {
                                        return "http://localhost:3000/v1/translate/en-ro";
                                    }else {
                                        return "http://localhost:3000/v1/translate/en-uk";
                                    }
                                }

                                //Wrap2 POST request
                                fetch(GetURL(SelectedLang), {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        },
                                    mode: 'cors',
                                    body,
                                }).then(function(response) {
                                    //status Error
                                    if (response.status >= 400 && response.status < 600) {
                                        alert("Error(check your console)");
                                        throw new Error("Bad response from server");
                                    }
                                    return response;
                                }).then(function (res) {
                                    res.text().then(function (data) {
                                        //string to array
                                        var start = data.indexOf("[");
                                        var end = data.indexOf("]", start+1);

                                        var str = data.substring(start+1, end); 
                                        var tmpList = str.replace(/"/gi,' ').split(",");
                                        const list = tmpList.map(x=>x.trim());
                                        return list;
                                    }).then(function(arr){
                                        //make refresh
                                        var parentNode = document.querySelector(".result");
                                        while (parentNode.firstChild) {
                                            parentNode.removeChild(parentNode.firstChild);
                                        };
                                        //string to button
                                        const tags = arr.map(x=>"<div>"+x+"</div>");
                                        console.log(tags);
                                        tags.forEach(function(tag){
                                            document.querySelector(".result").insertAdjacentHTML('beforeend',tag);
                                        });
                                    }).catch(error => console.error('Fetch Error:', error));
                                });
                            }); 
                        });
                    })
                    .catch(error => console.error('Fetch Error:', error));
                });
            });
        };
    </script>
</head>
<body>
    <div class="container">
        <h1>East Europe Translater</h1>
        <!--'action' 속성에는 입력된 로그인 데이터를 보낼 서버 페이지의 주소-->
        <form id="KRcontent" name="KRcontent" action="http://localhost:3000/v1/translate/ko-en" method="post">
            <div class="Wrap1 clear">
                <textarea id="text" name="text" placeholder="3000자 이하 입력"></textarea>
                <div id="text_cnt">(0 / 3000)</div>
                <input type="submit" value="전송" class="submit">
            </div>
        </form>
        <div class="Wrap2">
           <div class="lang">
                <input type="radio" name="lang" value="Ukraine">
                <label for="lang">Україна</label>
                <input type="radio" name="lang" value="romania">
                <label for="lang">România</label>
            </div>
            <div class="eng">
                <div class="help">1차 번역(영어)이 완료되면 최종 번역하실 언어와 마음에 드는 1차 번역을 눌러주세요.</div>
            </div>
        </div>
        <div class="Wrap3">
        
        <div class="result">
            <div class="help">최종 번역 결과</div>
        </div>
        </div>
    </div>
    <footer>
       <p>github: @blarbalr</p>
        <small>email: blarblar@blar.com</small>
    </footer>
</body>
</html>